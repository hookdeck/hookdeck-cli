version: 2
env:
  - GO111MODULE=on
before:
  hooks:
    - go mod download
    - go generate ./...
    - ./scripts/completions.sh
project_name: hookdeck
builds:
  - id: hookdeck-darwin
    ldflags:
      - -s -w -X github.com/hookdeck/hookdeck-cli/pkg/version.Version={{.Version}}
    binary: hookdeck
    env:
      - CGO_ENABLED=1
    main: ./main.go
    goos:
      - darwin
    goarch:
      - amd64
  - id: hookdeck-darwin-arm
    ldflags:
      - -s -w -X github.com/hookdeck/hookdeck-cli/pkg/version.Version={{.Version}}
    binary: hookdeck
    main: ./main.go
    goos:
      - darwin
    goarch:
      - arm64
changelog:
  sort: asc
  filters:
    exclude:
      - "^docs:"
      - "^test:"
checksum:
  name_template: "{{ .ProjectName }}-checksums.txt"
snapshot:
  name_template: "{{ .Tag }}-next"
archives:
  - id: hookdeck
    files:
      - completions/*
      - LICENSE*
      - README*
      - CHANGELOG*
brews:
  - name: hookdeck
    ids:
      - hookdeck
    repository:
      owner: hookdeck
      name: homebrew-hookdeck
    directory: Formula
    homepage: https://hookdeck.com
    description: Alternative to ngrok for localhost webhook development
    
    install: |
      bin.install "hookdeck"
      
      # Install completions from pre-generated files
      bash_completion.install "completions/hookdeck.bash" => "hookdeck"
      zsh_completion.install "completions/_hookdeck"
    
    caveats: |
      ⚠️  WARNING: This formula is deprecated!
      
      Please migrate to the cask version for the latest updates:
        brew uninstall hookdeck
        brew install --cask hookdeck/hookdeck/hookdeck
      
      The formula distribution will be removed in approximately 3-6 months.
      Learn more: https://goreleaser.com/blog/goreleaser-v2.10/#homebrew-casks

homebrew_casks:
  - name: hookdeck
    ids:
      - hookdeck
    repository:
      owner: hookdeck
      name: homebrew-hookdeck
    homepage: https://hookdeck.com
    description: Alternative to ngrok for localhost webhook development
    # Install shell completions automatically
    completions:
      bash: "completions/hookdeck.bash"
      zsh: "completions/_hookdeck"
    
    # Prevent installation alongside the deprecated formula
    # Note: The deprecated 'conflicts' field no longer works, so we use custom_block
    custom_block: |
      conflicts_with formula: "hookdeck"
    
    caveats: |
      Thanks for installing the Hookdeck CLI!
      
      If this is your first time using the CLI, run:
        hookdeck login
